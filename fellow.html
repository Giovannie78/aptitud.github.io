<script id="fellow-template" type="text/x-handlebars-template">
  <div class="fellow card-panel grey lighten-3 z-depth-2">
    <div class="row valign-wrapper">
      <div class="col s3">
        <img src="images/medarbetare/{{img}}" alt="" class="circle responsive-img">
      </div>
      <div class="col s8 s-offset-1">
        <span class="black-text">
          <h4 class="text-center">{{name}}</h4>
          <div class="desc text-justify">{{desc}}</div>
          <div class="contact row right-align">
            <ul>
              <li>
                <a rel='email' href="[email]{{name}}" target="_blank">
                  <span class="fa-stack fa-lg">
                        <i class="fa fa-envelope fa-stack-1x "></i>
                      </span>
                </a>
              </li>
              {{#if phone}}
              <li>
                <a href="tel:{{phone}}">
                  <span class="fa-stack fa-lg">
                        <i class="fa fa-phone fa-stack-1x "></i>
                      </span>
                </a>
              </li>
              {{/if}}{{#if blog}}
              <li>
                <a href="{{blog}}" target="_blank">
                  <span class="fa-stack fa-lg">
                        <i class="fa fa-globe fa-stack-1x "></i>
                      </span>
                </a>
              </li>
              {{/if}} {{#if services}} {{#each services}}
              <li>
                <a href="{{this.url}}" target="_blank">
                  <span class="fa-stack fa-lg">
                        <i class="fa fa-{{this.name}} fa-stack-1x "></i>
                      </span>
                </a>
              </li>
              {{/each}} {{/if}}
            </ul>
          </div>
        </span>
      </div>
    </div>
  </div>
</script>

<article class="orange-text text-lighten-5">
  <section>
    <div id="fellowPage" class="row">
      <div class="col s12 m10 offset-m1">
        <div id="fellow-list" class="row fellows" />
      </div>
    </div>
  </section>
</article>
<script>
  function shuffle(o) {
    for (var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
  }

  function addClearFix(layoutDiv, index) {
    if (index !== 0 && index % 3 === 0) {
      layoutDiv.append("<div class='clearfix visible-lg-block'></div>");
    }
    if (index !== 0 && index % 2 === 0) {
      layoutDiv.append("<div class='clearfix visible-sm-block'></div>");
    }
  }

  function layoutFellows(fellows) {
    var fellowTemplate = Handlebars.compile($("#fellow-template").html());
    var layoutDiv = $("#fellow-list");

    shuffle(fellows);
    fellows.forEach(function(fellow, index) {
      addClearFix(layoutDiv, index);
      layoutDiv.append(fellowTemplate(fellow));
    });
  }

  setBackgroundColor("#FF6633");

  function safeUpEmailAddresses() {
    $("a[rel='email']").each(function() {
      // Modify the mailto: value
      var mailtoVal = $(this).attr('href');
      mailtoVal = mailtoVal.replace(" ", ".");
      mailtoVal = mailtoVal.toLowerCase();
      mailtoVal = mailtoVal.replace("[email]", "mailto:");
      mailtoVal = mailtoVal.replace("å", "a");
      mailtoVal = mailtoVal.replace("ä", "a");
      mailtoVal = mailtoVal.replace("ö", "o");
      mailtoVal = mailtoVal.replace("ü", "u");

      mailtoVal = mailtoVal + "@" + "aptitud" + ".se";

      //console.log(mailtoVal);

      // Auto-generate title tags for users
      var mailtoTitle = mailtoVal.replace("mailto:", "Maila till ");
      $(this).attr('title', mailtoTitle);

      // onClick Event
      $(this).click(function() {
        window.open(mailtoVal, "_blank");
        return false;
      });
    });
  }

  $.getJSON("fellows.json").done(function(fellows) {
    layoutFellows(fellows);
    safeUpEmailAddresses();
    addDnDSupport();
  });

  var dragSrc = null;
  var addDnDSupport = function() {
    $(".fellow").each(function(index) {
      $(this).attr('draggable', 'true');
      $(this).bind('dragstart', function(e) {
        $(this).fadeTo("slow", 0.4);
        dragSrc = this;
        e.originalEvent.dataTransfer.effectAllowed = 'move';
        e.originalEvent.dataTransfer.setData('text/html', $(this).html());
      });
      $(this).bind('dragover', function(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        return false;
      });
      $(this).bind('dragenter', function(e) {

      });
      $(this).bind('dragleave', function(e) {

      });
      $(this).bind('drop', function(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }
        if (dragSrc != this) {
          dragSrc.innerHTML = this.innerHTML;
          this.innerHTML = e.originalEvent.dataTransfer.getData('text/html');
          $(dragSrc).fadeTo("slow", 1.0);
          $(this).fadeTo("slow", 1.0);
        }
        return false;
      });
      $(this).bind('dragend', function(e) {

      });
    })
  };
</script>
